<!DOCTYPE HTML>
<html>
<head>
  <meta charset="UTF-8">
  <!--link href="style.css" rel="stylesheet" type="text/css">
  <!--script defer src="js/test.js" type="text/javascript"></script-->
  <!--script src="js/array.js" type="text/javascript"></script-->
  <style>
    .main_block {
      float: left;
      width: 50%;
      background: #c9f76f;
      padding: 10px;
      margin: 5px;
      box-sizing: border-box;
      border-radius: 20px 20px 20px 20px;
    }
    .btn {
      
    }
  </style>
</head>
<body>
  <div id="content" class="main_block">
  HTML is great for declaring static documents, but it falters when we try to use it for declaring dynamic views in web-applications. AngularJS lets you extend HTML vocabulary for your application. The resulting environment is extraordinarily expressive, readable, and quick to develop.
  Привет медвед я рад волк
  </div>
    <!--div class="test_block" id="test_block">
      1
    </div>
    <div class="test_block">
      2
    </div>!!!!!!!
    <div class="test_block">
      3
    </div>
    <div class="test_block">
      4
    </div-->
    <!--div id="div2" class="test_block">
    <div id="div1" class="test_block">
    Привет!
    </div>
    Пока!
    </div-->
 
  <!--iframe frameborder="0" width="311" height="70" scrolling="no" src="http://www.lingvo.ua/ru/Partner/Form"></iframe-->
  <a href='javascript:(function(){var d,e,f,g,h,k,l;g={};l={event:{},h:{lang:"en-ru",R:"ru",O:7},start:function(){var a=this;d.C();document.body.addEventListener("mouseup",function(b){window.getSelection().toString()&&(a.event=b,d.G(window.getSelection().toString()))});document.body.addEventListener("mousedown",function(){window.getSelection().toString()&&window.getSelection().removeAllRanges()})}};f={translate:""};
e={f:"",P:function(){return this.f},J:function(a){this.f=this.v(a)},m:function(){return!~this.f.indexOf(" ")},v:function(a){return a.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,"")}};
xhrObject={g:"",w:"https://dictionary.yandex.net/api/v1/dicservice.json/lookup?",s:encodeURIComponent("dict.1.1.20161211T013101Z.4d434f548d2c6487.a0240ec240306be47446e646978bbb2c0f6ed6de"),A:"https://translate.yandex.net/api/v1.5/tr.json/translate?",u:encodeURIComponent("trnsl.1.1.20161211T003418Z.db5d3b30556edece.4057f1957d715db135b319a576dea6b5c2a6f198"),i:function(a){for(var b in a)this.g+="&"+b+"="+encodeURIComponent(a[b])},j:function(a){h=new XMLHttpRequest;h.open("GET",a);h.send();h.onload=
function(){d.l(this.responseText)}},H:function(a){this.g=this.w+"key="+this.s;this.i(a);this.j(this.g)},I:function(a){this.g=this.A+"key="+this.u;this.i(a);this.j(this.g)}};
k={a:"",b:{c:"",S:"<form class=bmkForm>                        <input>                        <input type=submit value=\u041f\u0435\u0440\u0435\u0432\u0435\u0441\u0442\u0438>                      </form>",T:"<div class=bmkLogo><p>\u041f\u0435\u0440\u0435\u0432\u0435\u0434\u0435\u043d\u043e \u0441\u0435\u0440\u0432\u0438\u0441\u043e\u043c <a href=http://translate.yandex.ru/>\u00ab\u042f\u043d\u0434\u0435\u043a\u0441.\u041f\u0435\u0440\u0435\u0432\u043e\u0434\u0447\u0438\u043a\u00bb</a></p>"},style:{".divTranslate":"{max-width: 400px;max-height: 200px;overflow: auto;border:2px solid blue;border-radius: 10px;padding: 15px 15px 1px 15px;margin-bottom: 15px;margin-top: 0px;position: absolute;z-index: 1000;background-color: white;}",
"::selection":"{background: #ADFF2F;}",".bmkLogo p":"{margin: 0px;}",".bmkForm input":"{width:auto;}"},M:function(){},N:function(){},F:function(a){var b,c;b=JSON.parse(a);c=b.def;console.log("trans");console.dir(a);console.log("trObj");console.dir(b);console.log("def");console.dir(c);this.b.c="<dl>";for(a=0;a<c.length;a++)if(this.b.c+="<dt>"+c[a].text+" <i>("+c[a].pos+")</i></dt>",c[a].tr)for(b=0;b<c[a].tr.length;b++)this.b.c+="<dd>"+c[a].tr[b].text+"</dd>";this.b.c+="</dl>"},D:function(a){this.b.c=
"<p>"+JSON.parse(a).text+"</p>"},o:function(a){var b=a.pageX;a=a.pageY;this.a&&(this.a.parentNode.removeChild(this.a),this.a="");this.a=document.createElement("div");this.a.style.left=b+20+"px";this.a.style.top=a+20+"px";this.a.className="divTranslate";for(var c in this.b)this.a.innerHTML+=this.b[c];document.body.appendChild(this.a)},B:function(){var a=document.createElement("style"),b;for(b in this.style)a.textContent+=b+this.style[b];document.body.appendChild(a)},L:function(a,b){this.F(a);this.o(b)},
K:function(a,b){this.D(a);this.o(b)}};d={C:function(){k.B()},G:function(a){e.J(a);g[e.f]?(console.log("get from cache"),console.dir(g),this.l(g[e.f])):(console.log("request..."),l.h.text=e.f,e.m()?xhrObject.H(l.h):xhrObject.I(l.h))},l:function(a){f.translate=a;g[e.f]=f.translate;e.m()?k.L(f.translate,l.event):k.K(f.translate,l.event)}};l.start();})()'>ᴂ переводчик</a>
</body>
<!--script src="functions.js"></script-->
<script>
  var mediator,
  textObject,
  translateObject,
  cache,
  xhr,
  view,
  userController;
  
  
  cache = {};
  
  userController = {
    event: {},
    paramsRequest: {
      lang: 'en-ru', // направление перевода
      ui: 'ru',
      flags: 0x000d
    },
    start: function(widget) {
      var self = this;
     // mediator.bmkStarted();
      document.body.addEventListener('mouseup', function(event){
        var selectedText = window.getSelection().toString();
          if(selectedText){ //если какой-то текст выделен пользователем
            self.event = event;
            mediator.gotTextObject( selectedText );
          }
        }
      );
      document.body.addEventListener('mousedown', function(event){
          if( window.getSelection().toString() && (event.which === 1) ){ //
            window.getSelection().removeAllRanges();
          }
        });
      widget.addEventListener('click', function(event){
          event.preventDefault();
          if( event.target.className == 'bmkHideButton' ){ //
            mediator.hideWidget();
          } else if (event.target.className == 'bmkFormButton') {
          // console.dir( document.querySelector('.bmkFormInput') );
            var text = document.querySelector('.bmkFormInput').value;
            mediator.gotTextObject(text);
           // console.log('eeee');
          } else if (event.target.className == 'bmkFormSelectLang') {
            //event.target.value
            self.paramsRequest.lang = event.target.value;
          } /*else if (event.target.className == 'bmkFormShowCache') {
            var winCache = window.open('about:blunk');
            var viewCache = '';
            for (var lang in cache) {
              viewCache += lang + '<br>';
              for(var str in cache[lang])
              viewCache += str + ': ' + cache[lang][str] + '<br>';
              console.log (cache[lang]);
            }
            winCache.document.write(viewCache);
          } */
        }
      );
    },
    
    
  };
 
  translateObject = {
    translate: ''
  };
  
  textObject = {
    _text: '',
    getText: function() {
        return this._text;
      },
    setText: function(text) {
        this._text = this._trim(text);
      },
    isOneWord: function() {
      return !(~this._text.indexOf(' ')); //
    },
    _trim: function(text) {
      return text.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g, '');
    }
  };

  xhrObject = {
    _url: '',
    _uriPathDictionary:'https://dictionary.yandex.net/api/v1/dicservice.json/lookup?',
    _apiKeyDictionary: encodeURIComponent('dict.1.1.20161211T013101Z.4d434f548d2c6487.a0240ec240306be47446e646978bbb2c0f6ed6de'),
    _uriPathInterpreter: 'https://translate.yandex.net/api/v1.5/tr.json/translate?',
    _apiKeyInterpreter: encodeURIComponent('trnsl.1.1.20161211T003418Z.db5d3b30556edece.4057f1957d715db135b319a576dea6b5c2a6f198'),
    
    _addParamsRequest: function(paramsRequest) {
      for (var prop in paramsRequest) {   
        this._url += '&' + prop + '=' + encodeURIComponent(paramsRequest[prop]);
      }
    },
    _request: function(url) {
      xhr = new XMLHttpRequest();
      xhr.open('GET', url);
      xhr.send();
      xhr.onload = function() {
         mediator.gotResponse(this.responseText);
      }
    },
    requestToDictionary: function(paramsRequest) {
      this._url = this._uriPathDictionary + 'key=' + this._apiKeyDictionary;
      this._addParamsRequest(paramsRequest);
      this._request(this._url);
    },
    requestToInterpreter: function(paramsRequest) {
      this._url = this._uriPathInterpreter + 'key=' + this._apiKeyInterpreter;
      this._addParamsRequest(paramsRequest);
      this._request(this._url);
    }
  };
  
  view = {
    widget:'', //HTMLElement
    components: {
      
    },
    style: {
      '.divTranslate': {
      'font': 'status-bar',
      'box-shadow':'1px 1px 10px 1px blue',
      'width' : 'auto',
      'box-sizing' : 'border-box',
    //  'max-height': '200px',
      'overflow': 'visible',
      'border': '2px solid blue',
      'border-radius': '10px',
      'padding': '20px 15px 1px 15px',
     // 'margin-bottom': '15px',
      //'margin-top': '0px',
      'position': 'absolute',
      'z-index': '1000',
      'background-color': 'white'
      },
      '::selection': {
        'background': '#ADFF2F'
      },
      '.bmkHideButton': {
      'position': 'absolute',
      'top': '-5px',
      'right': '-5px',
      'border-radius' : '50%'
      //'padding' : '0px'
     // 'overflow' : 'visible'

      },
      /*'.bmkHideButton *': {
      'font-stretch' : 'ultra-expanded',
      'font-weight': '900'
      },*/
      '.bmkLogo': {
      'margin': '0px',
      'font': 'small-caption',
      'text-align' : 'center'
      },
      '.bmkController': {
        'margin' : 'auto',
        'width': 'auto',
        'height': 'auto',
        'margin-top': '15px'
      },
      '.bmkController > *': {
        'display' : 'inline-block',
        'margin': '0px',
        'padding': '0px',
        'box-sizing' : 'border-box',
        'width' : '100%',
      },
      '.bmkController input': {
       // 'width' : '100%',
        'margin' : 'auto',
        //'border' : '0',
        //'background' : '#ADFF2F'
      },
      '.bmkController button': {
       // 'width' : '100%',
        
      },
      '.bmkController select': {
       // 'width' : '100%', 
      },
      '.translateElement' : {

        'text-align' : 'center',
        //'box-sizing' : 'border-box',
        'width' : 'auto'
      },
      '.translateElement table': {
        'border' : '1px solid',
        'border-collapse': 'collapse'
      },
      '.translateElement p': {
        'margin' : '0px'
      },
      '.translateElement table td, .translateElement table th' : {
        'border' : '1px solid',
        'vertical-align': 'top',
        'padding': '4px'
      },
      '.translateElement td': {
      //  'border' : '1px',
       // 'vertical-align': 'top'
       
       'height' : '1em'
      },
      'dl' : {
       // 'float' : 'left',
       // 'padding-left' : '10px',
        'display' : 'inline',

      },
      /*'.translateElement :last-child' : {
        'float' : 'none',
       // 'padding-left' : '10px',
        //'display' : 'inline-block'
      },*/
      'dt' : {
        'border-left' : '2px solid',
        'padding' : '0px 10px 0px 10px'
      },
      'dl:first-child dt' : {
        'border-left' : '0px',
        'padding-left' : '0px',
      },
    },
    createWidget: function() {
      this.createHideButton();
      this.createTranslateElement();
      this.createUserControlPanel();
      this.createLogo();
      
      this.widget = document.createElement('div');
      this.widget.className = 'divTranslate';
      console.dir(this.components);
      for (var i in this.components) {
        //console.log(this.components[i]);
        //this.widget.innerHTML += this.components[i];
        this.widget.appendChild(this.components[i]);
      }
      document.body.appendChild(this.widget);
      mediator.widgetCreated();
    },
    reloadWidget: function() {
      this.widget.replaceChild(this.components.HTMLTranslate, this.HTMLTranslate);
    },
    
    createHideButton: function() {
      this.components.hideButton = document.createElement('button');
      this.components.hideButton.className = 'bmkHideButton';
      this.components.hideButton.innerHTML = 'X';
    },
    createLogo: function() {
      this.components.yandexLogo = document.createElement('div');
      this.components.yandexLogo.className = 'bmkLogo';
      this.components.yandexLogo.innerHTML = 
                  '<p>Переведено сервисом ' +
                 '<a href=http://translate.yandex.ru/>«Яндекс.Переводчик»</a></p>';
                  
    },
    createUserControlPanel: function() {
      this.components.userControlPanel = document.createElement('form');
      this.components.userControlPanel.className = 'bmkController';
      
      
      for (var i in this.components.userControlPanel.components) {
        //console.log(this.components[i]);
        //this.widget.innerHTML += this.components[i];
        this.components.userControlPanel.appendChild(
          this.components.userControlPanel.components[i]);
      }
      this.components.userControlPanel.innerHTML = 
                // '<p>Панель управления:</p>'+
                 '<select class=bmkFormSelectLang><option selected value=en-ru>en-ru</option>' + 
                 '<option value=ru-en>ru-en</option></select>' +
                 '<textarea class=bmkFormInput placeholder=Перевести></textarea>' +
                 '<button  class=bmkFormButton>\u2192</button>' +
                 '<button  class=bmkFormShowCache>Просмотреть историю запросов</button>';
    },
    createTranslateElement: function() {
      this.components.HTMLTranslate = document.createElement('div');
      this.components.HTMLTranslate.className = 'translateElement';
      this.components.HTMLTranslate.innerHTML = 'Выделите текст мышкой или воспользуйтесь формой';
    },
    addTranslateWord: function(translate) {
      var i, 
      j,
      def,
      trObject,
      html='';
      
      trObject = JSON.parse(translate);
      def = trObject['def'];
      /*console.log('trans');
     console.dir(translate);
      console.log('trObj');
      console.dir(trObject);
      console.log('def');
      console.dir(def);*/
      console.dir(translate);
      
      //this.components.HTMLTranslate = '<dl>'; 
     /*
      html += '<table>';
      //html += '<caption>' + def['text'] + '</caption>';
      html += '<tr>';
     for (i = 0; i < def.length; i++ ) {
        html += '<td>';
        
        html += '<dl>';
        html += '<dt>' + def[i]['text'] + ' ' + '<i>(' + def[i]['pos']  + ')</i>' + '</dt>';
        
        if (def[i]['tr']) {
          for (j = 0; j < def[i]['tr'].length; j++) {
           
            html += '<dd>' + def[i]['tr'][j]['text'] + '</dd>';
          }
        }
        html += '</dl>';
        html += '</td>';
      }
      html += '</tr>';
      html += '</table>';
      */
      /*
      var table = document.createElement('table');
      var rows = [];
      var row = document.createElement('tr');
      for (i = 0; i < def.length; i++ ) {
        var th = document.createElement('th');
        th.innerHTML = def[i]['text'] + '' + '<i>(' + def[i]['pos']  + ')</i>';
        row.appendChild(th);     
      } 
      rows.push(row);
      
      row = document.createElement('tr');
      for (i = 0; i < def.length; i++ ) {
        var td = document.createElement('td');
        td.innerHTML = '';
        if (def[i]['tr']) {
          for (j = 0; j < def[i]['tr'].length; j++) {
            td.innerHTML += '<p>' + def[i]['tr'][j]['text'] + '</p>';
          //  html += '<p>' + def[i]['tr'][j]['text'] + '</p>';
          }
        }
        row.appendChild(td);  
      }
      rows.push(td);
     
      this.components.HTMLTranslate.appendChild(table);
      */
      
      
      
      html += '<table>';
     // html += '<caption>' + def[i]['text'] + '</caption>';
      html += '<tr>';
      for (i = 0; i < def.length; i++ ) {
       html += '<th>' + def[i]['text'] + ' ' + '<i>(' + def[i]['pos']  + ')</i>' + '</th>';
      } 
      html += '</tr>';
      html += '<tr>';
      
      for (i = 0; i < def.length; i++ ) {
        html += '<td>'
        if (def[i]['tr']) {
          for (j = 0; j < def[i]['tr'].length; j++) {
            html += '<p>' + def[i]['tr'][j]['text'] + '</p>';
          }
        }
        html += '</td>'
      } 
        
      
      
      html += '</table>';
      
      
      
      
      
     // this.components.HTMLTranslate += '</dl>';
     this.HTMLTranslate = this.components.HTMLTranslate;
     this.components.HTMLTranslate.innerHTML = html;
    },
   
    addTranslateSentence: function(translate) {
      this.HTMLTranslate = this.components.HTMLTranslate;
      this.components.HTMLTranslate.innerHTML = '<p>' + JSON.parse(translate).text + '</p>';
    },
    showWidget: function(event) {
      var x = 0;
      var y = 0;
      if (event) {
        x = event.pageX;
        y = event.pageY;
      }
      
      if (!this.widget) {
        this.createWidget();
      }
      //this.reloadWidget();
      this.widget.style.left = x + 20 + 'px';
      this.widget.style.top = y + 20 + 'px';
      this.widget.style.display = 'block';
      //document.body.appendChild(this.widget);
    },
    hideWidget: function() {
      this.widget.style.display = 'none';
    },    
    addStyle: function() {
      var styleTag = document.createElement('style');
      for (var selectorName in this.style) {
       // styleTag.textContent += prop + this.style[prop];
        styleTag.textContent += selectorName + '{';
        var selector = this.style[selectorName];
        for(var prop in selector) {
          styleTag.textContent += prop + ':' + selector[prop] + ' !important' + ';';
        }
        styleTag.textContent += '}';
      }
      document.body.appendChild(styleTag);
    },
    showTranslatedWord: function(translate, event){
      this.addTranslateWord(translate);
      this.reloadWidget();
      //this.createWidget();
      this.showWidget(event);
    },
    showTranslatedSentence: function(translate, event) {
      
      this.addTranslateSentence(translate);
      this.reloadWidget();
      //this.createWidget();
      this.showWidget(event);
    }
  };


  mediator = {
    start: function() {
      view.addStyle();
      view.showWidget();
      userController.start(view.widget);
    },
    gotTextObject: function(userText) {     
      console.dir(userText);    
      textObject.setText(userText);
      if( cache[userController.paramsRequest.lang] &&
      cache[userController.paramsRequest.lang][textObject.getText()] ) {
        console.log('get from cache');
       // console.dir(cache);
        this.gotResponse(cache[userController.paramsRequest.lang][textObject.getText()]);
      } else {
        console.log('request...');
        userController.paramsRequest.text = textObject.getText();
        
        if( textObject.isOneWord() ) {
          xhrObject.requestToDictionary(userController.paramsRequest);
        } else {
          xhrObject.requestToInterpreter(userController.paramsRequest);
        } 
      }
    },
    gotResponse: function(responseText) {
      translateObject.translate = responseText;
      if (!cache[userController.paramsRequest.lang]) {
        cache[userController.paramsRequest.lang] = {};
      }
      cache[userController.paramsRequest.lang][textObject.getText()] = translateObject.translate;
     // cache[textObject.getText()] = translateObject.translate;
      
      if( textObject.isOneWord() ) {
        view.showTranslatedWord(translateObject.translate, userController.event);
      } else {
        view.showTranslatedSentence(translateObject.translate, userController.event);
      }
    },
    hideWidget: function() {
      view.hideWidget();
    },
    widgetCreated: function() {
      
    }
  };
  
  mediator.start();
</script>
</html>